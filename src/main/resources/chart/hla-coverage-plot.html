<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8"/>
    <title xml:lang="en-US">- no title specified</title>

    <!--    <script src="https://d3js.org/d3.v7.min.js"></script>-->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        class GenoTypeDepth {
            countA = 0.0
            countT = 0.0
            countG = 0.0
            countC = 0.0
            countDeletion = 0.0

            constructor(source) {
                this.countA = source.CountA
                this.countT = source.CountT
                this.countG = source.CountG
                this.countC = source.CountC
                this.countSum = this.countA + this.countT + this.countG + this.countC
                this.countDeletion = source.CountDeletion
            }
        }

        let margin = { top: 50, right: 50, bottom: 50, left: 50 }
        let width = 1000 - margin.left - margin.right
        let height = 600 - margin.top - margin.bottom
        const Y_AXIS_UP_POSITION = 10

        async function drawChart() {
            const svg = initD3()

            const coveragePlotData = await loadData()

            const genoTypeDepthValues = Object.values(coveragePlotData.genotypeDepth)
            const genoTypeDepthList = new Array()
            genoTypeDepthValues.forEach(item => {
                genoTypeDepthList.push(new GenoTypeDepth(item))
            })

            initXAxis(svg, coveragePlotData);
            initYAxis(svg, genoTypeDepthList);

            // 차트 png 생성 콜백함수 바인딩 코드
            // generateChartPngImage(onGeneratedChartImage)
        }

        function initD3() {
            return d3.select('#d3_coverage_plot_chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
        }

        async function loadData() {
            // mustache 로 데이터를 삽입하는 코드
            // const data = `{{&jsonData}}`
            // return JSON.parse(data)

            // 로컬 서버를 이용한 데이터 로드 코드
            const response = await fetch('http://localhost:3000/hla/coveragePlotData.json', {
                method: 'GET'
            })
            return response.json()
        }

        function initXAxis(svg, coveragePlotData) {
            const genoTypeDepthValues = Object.values(coveragePlotData.genotypeDepth)

            const x = d3.scaleLinear()
                .domain([0, genoTypeDepthValues.length])
                .range([0, width])

            svg.append('g')
                .attr('transform', `translate(0,  ${height})`)
                .call(d3.axisBottom(x).ticks(5).tickSizeOuter(0))
        }

        function initYAxis(svg, genoTypeDepthList) {
            // TODO: genoTypeDepthList 의 countSum 최대값으로 y축 max 설정

            const y = d3.scaleLinear()
                .domain([0, 102])
                .range([height, 0])

            svg.append('g')
                .attr('transform', `translate(0, -${Y_AXIS_UP_POSITION})`)
                .call(d3.axisLeft(y).ticks(5).tickSizeOuter(0))
        }
    </script>
</head>
<body onload="drawChart()">
    <div id="d3_coverage_plot_chart"></div>
</body>
</html>