<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8"/>
    <title xml:lang="en-US">- no title specified</title>

    <!--    <script src="https://d3js.org/d3.v7.min.js"></script>-->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        class GenoTypeDepth {
            countA = 0.0
            countT = 0.0
            countG = 0.0
            countC = 0.0
            countDeletion = 0.0

            constructor(source) {
                this.countA = source.CountA
                this.countT = source.CountT
                this.countG = source.CountG
                this.countC = source.CountC
                this.countSum = this.countA + this.countT + this.countG + this.countC
                this.countDeletion = source.CountDeletion
            }
        }

        let margin = { top: 50, right: 50, bottom: 50, left: 50 }
        let width = 1000 - margin.left - margin.right
        let height = 600 - margin.top - margin.bottom
        const Y_AXIS_UP_POSITION = 10
        const CORE_EXON_SECTION_COLOR = '#eddefe'
        const INTRON_SECTION_COLOR = '#d2e9ff'
        const GUIDELINE_COLOR = '#c0c0c0'

        async function drawChart() {
            const svg = initD3()

            const coveragePlotData = await loadData()

            const genoTypeDepthValues = Object.values(coveragePlotData.genotypeDepth)
            const genoTypeDepthList = new Array()
            genoTypeDepthValues.forEach(item => {
                genoTypeDepthList.push(new GenoTypeDepth(item))
            })

            initXAxis(svg, coveragePlotData);
            const maxYValue = initYAxis(svg, genoTypeDepthList);
            drawCoverageBar(svg, genoTypeDepthList, maxYValue)
            drawAxisGuideLine(svg, maxYValue)
            drawSections(svg, coveragePlotData)
            drawHalfLine(svg)

            // 차트 png 생성 콜백함수 바인딩 코드
            // generateChartPngImage(onGeneratedChartImage)
        }

        function initD3() {
            return d3.select('#d3_coverage_plot_chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
        }

        async function loadData() {
            // mustache 로 데이터를 삽입하는 코드
            const data = `{{&jsonData}}`
            return JSON.parse(data)

            // 로컬 서버를 이용한 데이터 로드 코드
            // const response = await fetch('http://localhost:3000/hla/coveragePlotData.json', {
            //     method: 'GET'
            // })
            // return response.json()
        }

        function initXAxis(svg, coveragePlotData) {
            const genoTypeDepthValues = Object.values(coveragePlotData.genotypeDepth)

            const x = d3.scaleLinear()
                .domain([0, genoTypeDepthValues.length])
                .range([0, width])

            svg.append('g')
                .attr('transform', `translate(0,  ${height})`)
                .call(d3.axisBottom(x).ticks(5).tickSizeOuter(0))
        }

        function initYAxis(svg, genoTypeDepthList) {
            const maxValue = genoTypeDepthList
                .map(item => item.countSum)
                .reduce((a,b) => a > b ? a : b)

            const y = d3.scaleLinear()
                .domain([0, maxValue])
                .range([height, 0])

            svg.append('g')
                // .attr('transform', `translate(0, -${Y_AXIS_UP_POSITION})`)
                .call(d3.axisLeft(y).ticks(10).tickSizeOuter(0))

            return maxValue
        }

        function drawSections(svg, coveragePlotData) {
            const targetRegionList = coveragePlotData.targetRegionList

            const genoTypeDepthValues = Object.values(coveragePlotData.genotypeDepth)
            const genoTypeDepthValuesLength = genoTypeDepthValues.length.toFixed(2)

            // core exon
            targetRegionList
                .filter(item => item.Region === 'exon2' || item.Region === 'exon3')
                .forEach(item => {
                    const startXPercentage = item.StartPosition / genoTypeDepthValuesLength
                    const endXPercentage = item.EndPosition / genoTypeDepthValuesLength
                    const x1 = width * startXPercentage
                    const x2 = (width * endXPercentage) - x1
                    svg.append('rect')
                        .attr('x', x1)
                        .attr('y', 0)
                        .attr('width', x2)
                        .attr('height', height)
                        .style('fill', CORE_EXON_SECTION_COLOR)
                        .style('stroke', '#DDDDDD')
                        .style('opacity', 0.5)
                })

            // intron
            targetRegionList
                .filter(item => item.Region.includes('intron'))
                .forEach(item => {
                    const startXPercentage = item.StartPosition / genoTypeDepthValuesLength
                    const endXPercentage = item.EndPosition / genoTypeDepthValuesLength
                    const x1 = width * startXPercentage
                    const x2 = (width * endXPercentage) - x1
                    svg.append('rect')
                        .attr('x', x1)
                        .attr('y', 0)
                        .attr('width', x2)
                        .attr('height', height)
                        .style('fill', INTRON_SECTION_COLOR)
                        .style('stroke', '#DDDDDD')
                        .style('opacity', 0.5)
                })
        }

        function drawAxisGuideLine(svg, maxYValue) {
            const GUIDE_LINE_UNIT = 100
            const guideLineCount = maxYValue / GUIDE_LINE_UNIT
            for (let index = 1; index <= guideLineCount; index++) {
                const percentage = (GUIDE_LINE_UNIT * index) / Number.parseFloat(maxYValue)
                const y = height * percentage
                svg.append("line")
                    .style("stroke", GUIDELINE_COLOR)
                    .style('opacity', 0.4)
                    .attr("x1", 0)
                    .attr("y1", height - y)
                    .attr("x2", width)
                    .attr("y2", height - y)
            }
        }

        function drawHalfLine(svg) {
            svg.append("line")
                .style("stroke", '#f21149')
                .style('stroke-dasharray', '0 2 0')
                .attr("x1", 0)
                .attr("y1", height * 0.5)
                .attr("x2", width)
                .attr("y2", height * 0.5)
        }

        function drawCoverageBar(svg, genoTypeDepthList, maxYValue) {
            const genoTypeDepthListLength = genoTypeDepthList.length
            genoTypeDepthList.forEach((item, index) => {
                const xPercentage = index / (genoTypeDepthListLength * 1.0)
                const yPercentage = item.countSum / (maxYValue * 1.0);

                let xValue = width * xPercentage

                let yValue = height * yPercentage
                yValue = yValue > Y_AXIS_UP_POSITION ? yValue : Y_AXIS_UP_POSITION

                svg.append('rect')
                    .attr('x', xValue + 1)
                    .attr('y', height - yValue - 1)
                    .attr('width', 1)
                    .attr('height', yValue)
                    .style('fill', '#4ad5f7')
                    .style('opacity', 0.6)
            })
        }
    </script>
</head>
<body onload="drawChart()">
    <div id="d3_coverage_plot_chart"></div>
</body>
</html>